<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordSecurityService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">G07-EsiMedia-PI-User-Backend</a> &gt; <a href="index.source.html" class="el_package">com.esimedia.features.auth.services</a> &gt; <span class="el_source">PasswordSecurityService.java</span></div><h1>PasswordSecurityService.java</h1><pre class="source lang-java linenums">package com.esimedia.features.auth.services;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

/**
 * Servicio de seguridad de contraseñas que integra múltiples verificaciones.
 * Combina:
 * - PasswordDictionaryService: Verificación contra diccionario local
 * - LeakLookupService: Verificación contra brechas públicas
 */
@Service
public class PasswordSecurityService {

<span class="fc" id="L16">    private static final Logger logger = LoggerFactory.getLogger(PasswordSecurityService.class);</span>
    
    private final PasswordDictionaryService passwordDictionaryService;
    private final LeakLookupService leakLookupService;
    
    public PasswordSecurityService(PasswordDictionaryService passwordDictionaryService,
<span class="fc" id="L22">                                   LeakLookupService leakLookupService) {</span>
<span class="fc" id="L23">        this.passwordDictionaryService = passwordDictionaryService;</span>
<span class="fc" id="L24">        this.leakLookupService = leakLookupService;</span>
<span class="fc" id="L25">    }</span>
    
    /**
     * Verifica si una contraseña está en el diccionario de contraseñas típicas
     * 
     * @param password La contraseña a verificar
     * @return true si está en el diccionario, false si es segura
     */
    public boolean isPasswordInDictionary(String password) {
<span class="fc" id="L34">        return passwordDictionaryService.isPasswordInDictionary(password);</span>
    }
    
    /**
     * Verifica si una contraseña ha sido comprometida en brechas públicas
     * 
     * @param password La contraseña a verificar
     * @return true si ha sido comprometida, false si está segura
     */
    public boolean isPasswordCompromised(String password) {
<span class="fc" id="L44">        return leakLookupService.isPasswordCompromised(password);</span>
    }
    
    /**
     * Alias para isPasswordCompromised (compatible con controlador existente)
     * 
     * @param password La contraseña a verificar
     * @return true si ha sido comprometida en brechas, false si está segura
     */
    public boolean isPasswordLeaked(String password) {
<span class="fc" id="L54">        return leakLookupService.isPasswordCompromised(password);</span>
    }
    
    /**
     * Realiza una verificación completa de seguridad de contraseña
     * Verifica contra:
     * 1. Diccionario de contraseñas típicas
     * 2. Brechas de datos públicas (si está habilitado)
     * 
     * @param password La contraseña a verificar
     * @return Resultado detallado de la verificación
     */
    public PasswordSecurityCheckResult performSecurityCheck(String password) {
<span class="fc" id="L67">        logger.debug(&quot;Realizando verificación de seguridad de contraseña&quot;);</span>
        
<span class="fc" id="L69">        boolean inDictionary = false;</span>
<span class="fc" id="L70">        boolean isCompromised = false;</span>
        
        try {
<span class="fc" id="L73">            inDictionary = isPasswordInDictionary(password);</span>
        } 
<span class="fc" id="L75">        catch (Exception e) {</span>
<span class="fc" id="L76">            logger.error(&quot;Error al verificar diccionario: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L77">        }</span>
        
        try {
<span class="fc" id="L80">            isCompromised = isPasswordCompromised(password);</span>
        } 
<span class="fc" id="L82">        catch (Exception e) {</span>
<span class="fc" id="L83">            logger.error(&quot;Error al verificar brechas: {}&quot;, e.getMessage(), e);</span>
<span class="fc" id="L84">        }</span>
        
<span class="fc bfc" id="L86" title="All 4 branches covered.">        boolean isSecure = !inDictionary &amp;&amp; !isCompromised;</span>
<span class="fc" id="L87">        String message = generateSecurityMessage(inDictionary, isCompromised);</span>
        
<span class="fc" id="L89">        return new PasswordSecurityCheckResult(</span>
            isSecure,
            inDictionary,
            isCompromised,
            message
        );
    }
    
    /**
     * Genera un mensaje apropiado basado en los resultados de la verificación
     */
    private String generateSecurityMessage(boolean inDictionary, boolean isCompromised) {
<span class="fc bfc" id="L101" title="All 4 branches covered.">        if (inDictionary &amp;&amp; isCompromised) {</span>
<span class="fc" id="L102">            return &quot;La contraseña es muy común y ha sido comprometida en brechas de datos.&quot;;</span>
        } 
<span class="fc bfc" id="L104" title="All 2 branches covered.">        else if (inDictionary) {</span>
<span class="fc" id="L105">            return &quot;La contraseña es muy común. Por favor, elige una contraseña más fuerte.&quot;;</span>
        } 
<span class="fc bfc" id="L107" title="All 2 branches covered.">        else if (isCompromised) {</span>
<span class="fc" id="L108">            return &quot;La contraseña ha sido comprometida en una brecha de datos. Elige una diferente.&quot;;</span>
        } 
        else {
<span class="fc" id="L111">            return &quot;La contraseña es segura.&quot;;</span>
        }
    }
    
    /**
     * Obtiene información sobre el estado del sistema de verificación
     */
    public PasswordSecuritySystemStatus getSystemStatus() {
<span class="fc" id="L119">        return new PasswordSecuritySystemStatus(</span>
<span class="fc" id="L120">            passwordDictionaryService.isDictionaryLoaded(),</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            passwordDictionaryService.getDictionarySize(),</span>
            leakLookupService != null
        );
    }
    
    /**
     * Clase interna para encapsular el resultado de la verificación
     */
    public static class PasswordSecurityCheckResult {
        private final boolean isSecure;
        private final boolean inDictionary;
        private final boolean isCompromised;
        private final String message;
        
        public PasswordSecurityCheckResult(boolean isSecure, boolean inDictionary, 
<span class="fc" id="L136">                                          boolean isCompromised, String message) {</span>
<span class="fc" id="L137">            this.isSecure = isSecure;</span>
<span class="fc" id="L138">            this.inDictionary = inDictionary;</span>
<span class="fc" id="L139">            this.isCompromised = isCompromised;</span>
<span class="fc" id="L140">            this.message = message;</span>
<span class="fc" id="L141">        }</span>
        
<span class="fc" id="L143">        public boolean isSecure() { return isSecure; }</span>
<span class="fc" id="L144">        public boolean isInDictionary() { return inDictionary; }</span>
<span class="fc" id="L145">        public boolean isCompromised() { return isCompromised; }</span>
<span class="fc" id="L146">        public String getMessage() { return message; }</span>
    }
    
    /**
     * Clase interna para información del estado del sistema
     */
    public static class PasswordSecuritySystemStatus {
        private final boolean dictionaryLoaded;
        private final long dictionarySize;
        private final boolean leakLookupAvailable;
        
        public PasswordSecuritySystemStatus(boolean dictionaryLoaded, long dictionarySize,
<span class="fc" id="L158">                                           boolean leakLookupAvailable) {</span>
<span class="fc" id="L159">            this.dictionaryLoaded = dictionaryLoaded;</span>
<span class="fc" id="L160">            this.dictionarySize = dictionarySize;</span>
<span class="fc" id="L161">            this.leakLookupAvailable = leakLookupAvailable;</span>
<span class="fc" id="L162">        }</span>
        
<span class="fc" id="L164">        public boolean isDictionaryLoaded() { return dictionaryLoaded; }</span>
<span class="fc" id="L165">        public long getDictionarySize() { return dictionarySize; }</span>
<span class="fc" id="L166">        public boolean isLeakLookupAvailable() { return leakLookupAvailable; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>