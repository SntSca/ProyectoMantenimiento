<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UsuarioFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">G07-EsiMedia-PI-User-Backend</a> &gt; <a href="index.source.html" class="el_package">com.esimedia.features.auth.entity</a> &gt; <span class="el_source">UsuarioFactory.java</span></div><h1>UsuarioFactory.java</h1><pre class="source lang-java linenums">package com.esimedia.features.auth.entity;

import com.esimedia.features.auth.dto.AdministradorDTO;
import com.esimedia.features.auth.dto.CreadorContenidoDTO;
import com.esimedia.features.auth.dto.UsuarioDTO;
import com.esimedia.features.auth.dto.UsuarioNormalDTO;
import com.esimedia.features.auth.enums.Rol;
import com.esimedia.features.auth.services.ValidationService;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Component
public class UsuarioFactory {

    @Value(&quot;${app.security.pepper}&quot;)
    private String pepper;

<span class="fc" id="L21">    private static final Logger logger = LoggerFactory.getLogger(UsuarioFactory.class);</span>

    private UsuarioFactory() {}
    /**
     * Crea una instancia de Usuario a partir de un UsuarioDTO.
     * 
     * @param dto el DTO de usuario
     * @param validationService el servicio de validación para validar los datos
     * @param passwordService el servicio de codificación de contraseñas
     * @return una instancia de Usuario
     * @throws IllegalArgumentException si el tipo de DTO no es soportado
     * @throws NullPointerException si el dto es null
     * @throws org.springframework.web.server.ResponseStatusException si la validación falla
     */
    public Usuario crearUsuario(UsuarioDTO dto, ValidationService validationService) throws IllegalArgumentException, NullPointerException {
        
        // Validaciones básicas ahora van en DTO con Bean Validation (@ValidEmailDomain, etc.)
        // La validación del dominio de email ya se hace automáticamente en el DTO
        
        // Procesar fotoPerfil si está presente
<span class="fc" id="L41">        String fotoUri = null;</span>
<span class="pc bpc" id="L42" title="1 of 6 branches missed.">        if (dto.getFotoPerfil() != null &amp;&amp; !dto.getFotoPerfil().trim().isEmpty() &amp;&amp; dto.getFotoPerfil().startsWith(&quot;data:&quot;)) {</span>
                // Ya viene como data URI completa
<span class="fc" id="L44">                fotoUri = dto.getFotoPerfil();</span>
        }
        
        
<span class="fc bfc" id="L48" title="All 2 branches covered.">        if (dto instanceof UsuarioNormalDTO normalDTO) {</span>

                // Preservar el valor enviado por el cliente si no es null; por defecto false
<span class="pc bpc" id="L51" title="1 of 4 branches missed.">                boolean flagVIP = normalDTO.getFlagVIP() != null &amp;&amp; normalDTO.getFlagVIP();</span>
<span class="fc" id="L52">                logger.debug(&quot;[UsuarioFactory] flagVIP recibido en DTO: {} -&gt; usando: {}&quot;, normalDTO.getFlagVIP(), flagVIP);</span>
            
<span class="fc" id="L54">            return UsuarioNormal.builder()</span>
<span class="fc" id="L55">                .nombre(normalDTO.getNombre())</span>
<span class="fc" id="L56">                .apellidos(normalDTO.getApellidos())</span>
<span class="fc" id="L57">                .email(normalDTO.getEmail())</span>
<span class="fc" id="L58">                .alias(normalDTO.getAlias())</span>
<span class="fc" id="L59">                .password(encodePassword(normalDTO.getPassword()))</span>
<span class="fc" id="L60">                .fotoPerfil(fotoUri)</span>
<span class="fc" id="L61">                .fechaNacimiento(normalDTO.getFechaNacimiento())</span>
<span class="fc" id="L62">                .flagVIP(flagVIP)</span>
<span class="fc" id="L63">                .rol(Rol.NORMAL)</span>
<span class="fc" id="L64">                .build();</span>
        } 
<span class="fc bfc" id="L66" title="All 2 branches covered.">        else if (dto instanceof CreadorContenidoDTO creadorDTO) {</span>

<span class="fc" id="L68">            return CreadorContenido.builder()</span>
<span class="fc" id="L69">                .nombre(creadorDTO.getNombre())</span>
<span class="fc" id="L70">                .apellidos(creadorDTO.getApellidos())</span>
<span class="fc" id="L71">                .email(creadorDTO.getEmail())</span>
<span class="fc" id="L72">                .alias(creadorDTO.getAlias())</span>
<span class="fc" id="L73">                .password(encodePassword(creadorDTO.getPassword()))</span>
<span class="fc" id="L74">                .fotoPerfil(fotoUri)</span>
<span class="fc" id="L75">                .aliasCreador(creadorDTO.getAliasCreador())</span>
<span class="fc" id="L76">                .descripcion(creadorDTO.getDescripcion())</span>
<span class="fc" id="L77">                .tipoContenido(creadorDTO.getTipoContenido())</span>
<span class="fc" id="L78">                .especialidad(creadorDTO.getEspecialidad())</span>
<span class="fc" id="L79">                .rol(Rol.CREADOR)</span>
<span class="fc" id="L80">                .build();</span>
        } 
<span class="fc bfc" id="L82" title="All 2 branches covered.">        else if (dto instanceof AdministradorDTO adminDTO) {</span>
<span class="fc" id="L83">            return Administrador.builder()</span>
<span class="fc" id="L84">                .nombre(adminDTO.getNombre())</span>
<span class="fc" id="L85">                .apellidos(adminDTO.getApellidos())</span>
<span class="fc" id="L86">                .email(adminDTO.getEmail())</span>
<span class="fc" id="L87">                .alias(adminDTO.getAlias())</span>
<span class="fc" id="L88">                .password(encodePassword(adminDTO.getPassword()))</span>
<span class="fc" id="L89">                .fotoPerfil(fotoUri)</span>
<span class="fc" id="L90">                .departamento(adminDTO.getDepartamento())</span>
<span class="fc" id="L91">                .rol(Rol.ADMINISTRADOR)</span>
<span class="fc" id="L92">                .build();</span>
        }
        
<span class="fc" id="L95">        throw new IllegalArgumentException(&quot;Tipo de DTO no soportado: &quot; + dto.getClass().getSimpleName());</span>
    }

    /**
     * Codifica la contraseña usando Argon2 con pepper.
     * 
     * @param password la contraseña en texto plano
     * @return la contraseña codificada en Base64
     */
    private String encodePassword(String password) throws SecurityException {
<span class="fc" id="L105">        String passwordWithPepper = password + pepper;</span>
<span class="fc" id="L106">        de.mkammerer.argon2.Argon2 argon2 = de.mkammerer.argon2.Argon2Factory.create(de.mkammerer.argon2.Argon2Factory.Argon2Types.ARGON2id);</span>
<span class="fc" id="L107">        int memory = 65536;</span>
<span class="fc" id="L108">        int iterations = 3;</span>
<span class="fc" id="L109">        int parallelism = 1;</span>
<span class="fc" id="L110">        String hash = argon2.hash(iterations, memory, parallelism, passwordWithPepper.toCharArray());</span>
<span class="fc" id="L111">        argon2.wipeArray(passwordWithPepper.toCharArray());</span>
<span class="fc" id="L112">        return hash;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>