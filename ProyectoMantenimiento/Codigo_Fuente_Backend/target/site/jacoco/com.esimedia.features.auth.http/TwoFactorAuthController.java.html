<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TwoFactorAuthController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">G07-EsiMedia-PI-User-Backend</a> &gt; <a href="index.source.html" class="el_package">com.esimedia.features.auth.http</a> &gt; <span class="el_source">TwoFactorAuthController.java</span></div><h1>TwoFactorAuthController.java</h1><pre class="source lang-java linenums">package com.esimedia.features.auth.http;

import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.server.ResponseStatusException;

import com.esimedia.features.auth.services.TwoFactorAuthService;
import com.esimedia.features.auth.dto.CodeVerificationDTO;
import com.esimedia.features.auth.dto.TotpSetupResponse;

import jakarta.validation.Valid;

@RestController
@RequestMapping(&quot;/auth/2fa&quot;)
@CrossOrigin(origins = &quot;http://localhost:4200&quot;, allowedHeaders = &quot;*&quot;, exposedHeaders = &quot;Authorization&quot;)
public class TwoFactorAuthController {

<span class="fc" id="L29">    private static final Logger logger = LoggerFactory.getLogger(TwoFactorAuthController.class);</span>
    private static final String MESSAGE_KEY = &quot;message&quot;;
    
    // Response messages
    private static final String CODE_VERIFIED_SUCCESSFULLY = &quot;Código verificado exitosamente&quot;;
    private static final String CODE_INVALID_OR_EXPIRED = &quot;Código inválido o expirado&quot;;
    private static final String TOTP_CODE_VERIFIED_SUCCESSFULLY = &quot;Código TOTP verificado exitosamente&quot;;
    private static final String TOTP_CODE_INVALID = &quot;Código TOTP inválido&quot;;
    private static final String QR_SETUP_MESSAGE = &quot;Escanea el código QR con tu aplicación de autenticación y confirma con un código&quot;;
    
    // Response keys
    private static final String QR_CODE_URL_KEY = &quot;qrCodeUrl&quot;;
    private static final String SECRET_KEY = &quot;secretKey&quot;;
    
<span class="fc" id="L43">    private final TwoFactorAuthService twoFactorAuthService;    public TwoFactorAuthController(TwoFactorAuthService twoFactorAuthService) {</span>
<span class="fc" id="L44">        this.twoFactorAuthService = twoFactorAuthService;</span>
<span class="fc" id="L45">    }</span>



    // ===== FACTOR 2: CÓDIGOS POR EMAIL =====

    /**
     * Envía un código de verificación por email al usuario autenticado
     */
    @PostMapping(&quot;/email/send&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; sendEmailCode(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L56">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
        
<span class="fc" id="L58">        logger.info(&quot;Usuario {} solicitó código por email&quot;, userId);</span>
<span class="fc" id="L59">        String message = twoFactorAuthService.sendEmailVerificationCode(userId);</span>
        
<span class="fc" id="L61">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código enviado por email
     */
    @PostMapping(&quot;/email/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyEmailCode(
            @RequestHeader(&quot;Authorization&quot;) String authHeader, 
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L72">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L73">        String code = payload.getCode();</span>
        
<span class="fc" id="L75">        boolean isValid = twoFactorAuthService.verifyEmailCode(userId, code);</span>
        
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (isValid) {</span>
<span class="fc" id="L78">            logger.info(&quot;Código de email verificado exitosamente para usuario {}&quot;, userId);</span>
<span class="fc" id="L79">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, CODE_VERIFIED_SUCCESSFULLY));</span>
        } 
        else 
        {
<span class="fc" id="L83">            logger.warn(&quot;Código de email inválido para usuario {}&quot;, userId);</span>
<span class="fc" id="L84">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, CODE_INVALID_OR_EXPIRED);</span>
        }
    }

    // ===== FACTOR 3: TOTP (CÓDIGOS QR) =====

    /**
     * Configura TOTP para el usuario - Genera QR
     */
    @PostMapping(&quot;/totp/setup&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; setupTotp(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L95">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>

<span class="fc" id="L97">        logger.info(&quot;Usuario {} iniciando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L98">        TotpSetupResponse response = twoFactorAuthService.setupTotp(userId);</span>
        
<span class="fc" id="L100">        return ResponseEntity.ok(Map.of(</span>
<span class="fc" id="L101">            QR_CODE_URL_KEY, response.getQrCodeUrl(),</span>
<span class="fc" id="L102">            SECRET_KEY, response.getSecretKey(),</span>
            MESSAGE_KEY, QR_SETUP_MESSAGE
        ));
    }

    /**
     * Confirma la configuración TOTP con el primer código
     */
    @PostMapping(&quot;/totp/confirm&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; confirmTotpSetup(
            @RequestHeader(&quot;Authorization&quot;) String authHeader, 
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L115">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L116">        String code = payload.getCode();</span>
        
<span class="fc" id="L118">        logger.info(&quot;Usuario {} confirmando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L119">        String message = twoFactorAuthService.confirmTotpSetup(userId, code);</span>
        
<span class="fc" id="L121">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código TOTP durante el login
     */
    @PostMapping(&quot;/totp/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyTotpCode(
            @RequestHeader(&quot;Authorization&quot;) String authHeader, 
            @Valid @RequestBody CodeVerificationDTO payload) {
        
<span class="fc" id="L132">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L133">        String code = payload.getCode();</span>
        
<span class="fc" id="L135">        boolean isValid = twoFactorAuthService.verifyTotpCode(userId, code);</span>
        
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if (isValid) {</span>
<span class="fc" id="L138">            logger.info(&quot;Código TOTP verificado exitosamente para usuario {}&quot;, userId);</span>
<span class="fc" id="L139">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, TOTP_CODE_VERIFIED_SUCCESSFULLY));</span>
        }
        else {
<span class="fc" id="L142">            logger.warn(&quot;Código TOTP inválido para usuario {}&quot;, userId);</span>
<span class="fc" id="L143">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, TOTP_CODE_INVALID);</span>
        }
    }

    /**
     * Desactiva 2FA para el usuario
     */
    @PostMapping(&quot;/disable&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; disableTwoFactor(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L152">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
        
<span class="fc" id="L154">        logger.info(&quot;Usuario {} desactivando 2FA&quot;, userId);</span>
<span class="fc" id="L155">        String message = twoFactorAuthService.disableTwoFactor(userId);</span>
        
<span class="fc" id="L157">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Desactiva el tercer factor (TOTP) para el usuario
     */
    @PostMapping(&quot;/totp/disable&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; disableThirdFactor(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L165">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
        
<span class="fc" id="L167">        logger.info(&quot;Usuario {} desactivando tercer factor (TOTP)&quot;, userId);</span>
<span class="fc" id="L168">        String message = twoFactorAuthService.disableThirdFactor(userId);</span>
        
<span class="fc" id="L170">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }
    

    // ===== ENDPOINTS PARA ADMINISTRADORES =====

    /**
     * Envía un código de verificación por email al administrador autenticado
     */
    @PostMapping(&quot;/admin/email/send&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; sendEmailCodeAdmin(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L181">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>

<span class="fc" id="L183">        logger.info(&quot;Administrador {} solicitó código por email&quot;, userId);</span>
<span class="fc" id="L184">        String message = twoFactorAuthService.sendEmailVerificationCode(userId);</span>

<span class="fc" id="L186">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código enviado por email para administrador
     */
    @PostMapping(&quot;/admin/email/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyEmailCodeAdmin(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L197">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L198">        String code = payload.getCode();</span>

<span class="fc" id="L200">        boolean isValid = twoFactorAuthService.verifyEmailCodeAdmin(userId, code);</span>

<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L203">            logger.info(&quot;Código de email verificado exitosamente para administrador {}&quot;, userId);</span>
<span class="fc" id="L204">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, CODE_VERIFIED_SUCCESSFULLY));</span>
        }
        else
        {
<span class="nc" id="L208">            logger.warn(&quot;Código de email inválido para administrador {}&quot;, userId);</span>
<span class="nc" id="L209">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, CODE_INVALID_OR_EXPIRED);</span>
        }
    }

    /**
     * Configura TOTP para el administrador - Genera QR
     */
    @PostMapping(&quot;/admin/totp/setup&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; setupTotpAdmin(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L218">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>

<span class="fc" id="L220">        logger.info(&quot;Administrador {} iniciando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L221">        TotpSetupResponse response = twoFactorAuthService.setupTotpAdmin(userId);</span>

<span class="fc" id="L223">        return ResponseEntity.ok(Map.of(</span>
<span class="fc" id="L224">            QR_CODE_URL_KEY, response.getQrCodeUrl(),</span>
<span class="fc" id="L225">            SECRET_KEY, response.getSecretKey(),</span>
            MESSAGE_KEY, QR_SETUP_MESSAGE
        ));
    }

    /**
     * Confirma la configuración TOTP con el primer código para administrador
     */
    @PostMapping(&quot;/admin/totp/confirm&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; confirmTotpSetupAdmin(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L238">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L239">        String code = payload.getCode();</span>

<span class="fc" id="L241">        logger.info(&quot;Administrador {} confirmando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L242">        String message = twoFactorAuthService.confirmTotpSetupAdmin(userId, code);</span>

<span class="fc" id="L244">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código TOTP para administrador durante el login
     */
    @PostMapping(&quot;/admin/totp/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyTotpCodeAdmin(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L255">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L256">        String code = payload.getCode();</span>

<span class="fc" id="L258">        boolean isValid = twoFactorAuthService.verifyTotpCodeAdmin(userId, code);</span>

<span class="pc bpc" id="L260" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L261">            logger.info(&quot;Código TOTP verificado exitosamente para administrador {}&quot;, userId);</span>
<span class="fc" id="L262">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, TOTP_CODE_VERIFIED_SUCCESSFULLY));</span>
        } 
        else {
<span class="nc" id="L265">            logger.warn(&quot;Código TOTP inválido para administrador {}&quot;, userId);</span>
<span class="nc" id="L266">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, TOTP_CODE_INVALID);</span>
        }
    }

    // ===== ENDPOINTS PARA CREADORES DE CONTENIDO =====

    /**
     * Envía un código de verificación por email al creador de contenido autenticado
     */
    @PostMapping(&quot;/creator/email/send&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; sendEmailCodeCreator(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L277">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>

<span class="fc" id="L279">        logger.info(&quot;Creador {} solicitó código por email&quot;, userId);</span>
<span class="fc" id="L280">        String message = twoFactorAuthService.sendEmailVerificationCode(userId);</span>

<span class="fc" id="L282">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código enviado por email para creador de contenido
     */
    @PostMapping(&quot;/creator/email/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyEmailCodeCreator(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L293">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L294">        String code = payload.getCode();</span>

<span class="fc" id="L296">        boolean isValid = twoFactorAuthService.verifyEmailCodeCreador(userId, code);</span>

<span class="pc bpc" id="L298" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L299">            logger.info(&quot;Código de email verificado exitosamente para creador {}&quot;, userId);</span>
<span class="fc" id="L300">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, CODE_VERIFIED_SUCCESSFULLY));</span>
        }
        else
        {
<span class="nc" id="L304">            logger.warn(&quot;Código de email inválido para creador {}&quot;, userId);</span>
<span class="nc" id="L305">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, CODE_INVALID_OR_EXPIRED);</span>
        }
    }

    /**
     * Configura TOTP para el creador de contenido - Genera QR
     */
    @PostMapping(&quot;/creator/totp/setup&quot;)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; setupTotpCreator(@RequestHeader(&quot;Authorization&quot;) String authHeader) {
<span class="fc" id="L314">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>

<span class="fc" id="L316">        logger.info(&quot;Creador {} iniciando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L317">        TotpSetupResponse response = twoFactorAuthService.setupTotpCreador(userId);</span>

<span class="fc" id="L319">        return ResponseEntity.ok(Map.of(</span>
<span class="fc" id="L320">            QR_CODE_URL_KEY, response.getQrCodeUrl(),</span>
<span class="fc" id="L321">            SECRET_KEY, response.getSecretKey(),</span>
            MESSAGE_KEY, QR_SETUP_MESSAGE
        ));
    }

    /**
     * Confirma la configuración TOTP con el primer código para creador de contenido
     */
    @PostMapping(&quot;/creator/totp/confirm&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; confirmTotpSetupCreator(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L334">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L335">        String code = payload.getCode();</span>

<span class="fc" id="L337">        logger.info(&quot;Creador {} confirmando configuración TOTP&quot;, userId);</span>
<span class="fc" id="L338">        String message = twoFactorAuthService.confirmTotpSetupCreador(userId, code);</span>

<span class="fc" id="L340">        return ResponseEntity.ok(Map.of(MESSAGE_KEY, message));</span>
    }

    /**
     * Verifica un código TOTP para creador de contenido durante el login
     */
    @PostMapping(&quot;/creator/totp/verify&quot;)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; verifyTotpCodeCreator(
            @RequestHeader(&quot;Authorization&quot;) String authHeader,
            @Valid @RequestBody CodeVerificationDTO payload) {

<span class="fc" id="L351">        String userId = twoFactorAuthService.validarEntradaPara2O3FA(authHeader);</span>
<span class="fc" id="L352">        String code = payload.getCode();</span>

<span class="fc" id="L354">        boolean isValid = twoFactorAuthService.verifyTotpCodeCreador(userId, code);</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L357">            logger.info(&quot;Código TOTP verificado exitosamente para creador {}&quot;, userId);</span>
<span class="fc" id="L358">            return ResponseEntity.ok(Map.of(MESSAGE_KEY, TOTP_CODE_VERIFIED_SUCCESSFULLY));</span>
        } 
        else {
<span class="nc" id="L361">            logger.warn(&quot;Código TOTP inválido para creador {}&quot;, userId);</span>
<span class="nc" id="L362">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, TOTP_CODE_INVALID);</span>
        }
    }

    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>