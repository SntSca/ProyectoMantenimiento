name: CD Pipeline

trigger:
  branches:
    include:
    - releases

pool:
  name: 'UCLM-Sonar-scanner-Host'

stages:
- stage: Deploy
  displayName: 'Deploy to Firebase'
  jobs:
  - job: DeployToFirebase
    displayName: 'Deploy Angular app to Firebase Hosting'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.x'
      displayName: 'Install Node.js'
    
    - powershell: |
        npm update
        npm install -g @angular/cli firebase-tools
        npm install
        ng build --configuration production
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed with exit code $LASTEXITCODE"
          exit $LASTEXITCODE
        }
      displayName: 'Install dependencies and build'
    
    - powershell: |
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Build source directory: $(Build.SourcesDirectory)"
        if (Test-Path "dist/esimedia-frontend/browser/index.html") {
          Write-Host "✓ Build directory found"
          Get-ChildItem "dist/esimedia-frontend/browser" | Select-Object Name
        } else {
          Write-Host "✗ Build directory NOT found - build may have failed"
          exit 1
        }
      displayName: 'Verify build directory exists'
    
    - script: |
        firebase deploy --token $(FIREBASE_TOKEN) --project esimedia-frontend-9b8cd
      displayName: 'Deploy to Firebase'