<div class="dashboard-container gestor-variant">
  <!-- Menu Lateral Izquierdo -->
  <aside class="sidebar-menu">
    <button type="button" class="user-profile" [routerLink]="GESTOR_ROUTES.perfil">
      <div class="avatar-container">
        <img src="{{ actualGestor.fotoPerfil || 'assets/porDefecto.jpg' }}" alt="Avatar del usuario" class="user-avatar">
      </div>
      <div class="user-info">
        <h3 class="user-name">{{ actualGestor.alias }}</h3>
        <p class="profile-hint">üë§ Ver perfil</p>
      </div>
    </button>

    <nav class="menu-navigation">
      <ul class="menu-list">
        <li class="menu-item">
          <button type="button" class="menu-button" [routerLink]="GESTOR_ROUTES.inicio">
            <div class="menu-text">
              <span class="menu-icon">üè†</span>
              <span>Inicio</span>
            </div>
          </button>
        </li>
        <li class="menu-item active">
          <div class="menu-text">
            <span class="menu-icon">üì§</span>
            <span>Subir Contenido</span>
          </div>
        </li>
        <li class="menu-item">
          <button type="button" class="menu-button" [routerLink]="GESTOR_ROUTES.crearListaPublica">
            <div class="menu-text">
              <span class="menu-icon">‚ûï</span>
              <span>Crear Lista P√∫blica</span>
            </div>
          </button>
        </li>
        <li class="menu-item">
          <button type="button" class="menu-button" [routerLink]="GESTOR_ROUTES.listas">
            <div class="menu-text">
              <span class="menu-icon">üìã</span>
              <span>Listas de Reproducci√≥n</span>
            </div>
          </button>
        </li>
      </ul>

      <div class="menu-divider"></div>

      <ul class="menu-list">
        <li class="menu-item logout">
          <button [routerLink]="APP_ROUTES.home" class="logout-button">
            <div class="menu-text">
              <span class="menu-icon">üö™</span>
              <span>Cerrar Sesi√≥n</span>
            </div>
          </button>
        </li>
      </ul>
    </nav>
  </aside>

  <!-- Contenido Principal -->
  <main class="main-content">
    <!-- Header -->
    <header class="app-header">
      <h1 class="header-title">Subir Nuevo Contenido</h1>
      <p class="header-subtitle">Comparte tu contenido con la comunidad</p>
    </header>

    <!-- Formulario de Subida de Contenido -->
    <div class="upload-container">
      <h2 class="section-title">Subir Contenido de {{ actualGestor.tipoContenido | titlecase }}</h2>
      <form [formGroup]="currentForm" (ngSubmit)="onSubmit()" class="upload-form">

        <!-- Informaci√≥n B√°sica -->
        <section class="form-section">
          <h2 class="section-title">Informaci√≥n del Contenido</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="titulo" class="form-label">T√≠tulo *</label>
              <input
                id="titulo"
                type="text"
                formControlName="titulo"
                class="form-input"
                [class.input-error]="currentForm && isFieldInvalid(currentForm, 'titulo')"
                placeholder="Ingresa el t√≠tulo de tu contenido">
              <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'titulo')">  <!-- Agregada verificaci√≥n para currentForm -->
                {{ getFieldError(currentForm, 'titulo') }}
              </div>
            </div>

            <div class="form-group">
              <label for="tags" class="form-label">Tags *</label>
              <div class="custom-dropdown" [class.dropdown-open]="isTagsDropdownOpen">
                <button type="button" class="dropdown-toggle form-select" [class.input-error]="currentForm && isFieldInvalid(currentForm, 'tags')" (click)="toggleTagsDropdown()">
                  {{ getSelectedTagsText() }}
                </button>
                <div class="dropdown-menu" [hidden]="!isTagsDropdownOpen" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
                  <div class="dropdown-item" *ngFor="let tag of tags; let i = index">
                    <label class="checkbox-label" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
                      <input
                        type="checkbox"
                        [checked]="isTagSelected(tag)"
                        (change)="onTagChange(tag, $any($event.target).checked)">
                      {{ tag.nombre }}
                    </label>
                  </div>
                </div>
              </div>
              <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'tags')">
                {{ getFieldError(currentForm, 'tags') }}
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="descripcion" class="form-label">Descripci√≥n *</label>
            <textarea
              id="descripcion"
              formControlName="descripcion"
              class="form-textarea"
              [class.input-error]="currentForm && isFieldInvalid(currentForm, 'descripcion')"
              placeholder="Describe tu contenido..."
              rows="4"></textarea>
            <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'descripcion')">  <!-- Agregada verificaci√≥n para currentForm -->
              {{ getFieldError(currentForm, 'descripcion') }}
            </div>
          </div>
        </section>

        <!-- Archivo de Contenido - Solo para Audio -->
        <section class="form-section" *ngIf="actualGestor.tipoContenido === 'AUDIO'">
          <h2 class="section-title">Archivo de Contenido</h2>

          <!-- Subida de archivo de audio -->
          <div class="form-group">
            <div class="form-label">Seleccionar Archivo de Audio *</div>
            <div class="file-upload-area" [class.drag-over]="isDragOver">
              <input
                type="file"
                id="audioFileInput"
                (change)="onFileSelected($event)"
                [attr.accept]="acceptExtensionsAudio"
                style="display: none;">
              <label for="audioFileInput" class="file-upload-button">
                <span class="upload-icon">üìÅ</span>
                <span class="upload-text">
                  {{ selectedAudioFile ? selectedAudioFile.name : 'Haz clic para seleccionar o arrastra un archivo de audio aqu√≠' }}
                </span>
              </label>
            </div>
            <small class="form-hint">
                Formatos soportados: {{ formatosFicheros.extensiones.join(', ') }}
              </small>
          </div>

          <!-- Preview del contenido -->
          <div *ngIf="audioPreviewUrl" class="file-preview">
            <h3>Vista Previa del Audio:</h3>
            <audio [src]="audioPreviewUrl" controls class="preview-media"></audio>
          </div>
        </section>

        <!-- URL del Video - Solo para Video -->
        <section class="form-section" *ngIf="actualGestor.tipoContenido === 'VIDEO'">
          <h2 class="section-title">URL del Video</h2>

          <div class="form-group">
            <label for="videoUrl" class="form-label">URL del Video *</label>
            <input
              type="url"
              id="videoUrl"
              formControlName="url"
              (input)="onVideoUrlChange($any($event.target).value)"
              class="form-input"
              [class.input-error]="currentForm && isFieldInvalid(currentForm, 'url')"
              placeholder="https://ejemplo.com/video.mp4">
            <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'url')">  <!-- Agregada verificaci√≥n para currentForm -->
              {{ getFieldError(currentForm, 'url') }}
            </div>
            <small class="form-hint">
              Ingresa la URL completa del video (YouTube, Vimeo)
            </small>
          </div>

          <!-- Preview del video -->
          <div *ngIf="embedUrl" class="file-preview">
            <h3>Vista Previa del Video:</h3>
            <iframe [src]="embedUrl || 'assets/miniaturaPorDefecto.png'" [title]="'Vista previa del video'" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="preview-media"></iframe>
          </div>
          <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'url')">
            No se pudo cargar la vista previa. Verifica la URL.
          </div>
        </section>

        <!-- Miniatura -->
        <section class="form-section">
          <h2 class="section-title">Miniatura</h2>
          <div class="form-row">
            <div class="form-group">
              <div class="form-label">Seleccionar Miniatura *</div>
              <input
                type="file"
                id="thumbnailInput"
                (change)="onThumbnailSelected($event)"
                [accept]="acceptExtensionsImagen"
                style="display: none;">
              <label for="thumbnailInput" class="file-upload-button thumbnail-button">
                <span class="upload-icon">üñºÔ∏è</span>
                <span class="upload-text">
                  {{ selectedThumbnail ? selectedThumbnail.name : 'Seleccionar miniatura' }}
                </span>
              </label>
              <small class="form-hint">
                Formatos soportados: {{ formatosImagen.extensiones.join(', ') }}
              </small>
            </div>
          </div>

          <!-- Preview de la miniatura -->
          <div *ngIf="thumbnailPreviewUrl" class="thumbnail-preview">
            <h3>Vista Previa de Miniatura:</h3>
            <img [src]="thumbnailPreviewUrl" alt="Miniatura preview" class="preview-thumbnail">
          </div>
        </section>

        <!-- Configuraci√≥n Avanzada -->
        <section class="form-section">
          <h2 class="section-title">Configuraci√≥n Avanzada</h2>

          <div class="form-row">
            <div class="form-group">
              <label for="pegi" class="form-label">Clasificaci√≥n PEGI *</label>
              <select
                id="pegi"
                formControlName="pegi"
                class="form-select"
                [class.input-error]="currentForm && isFieldInvalid(currentForm, 'pegi')">
                <option *ngFor="let pegi of pegiOptions" [value]="pegi">
                  PEGI {{ pegi }}
                </option>
              </select>
            </div>

            <div *ngIf="actualGestor.tipoContenido === 'VIDEO'">
              <div class="form-group">
                <label for="resolucion" class="form-label">Resoluci√≥n *</label>
                <select
                  id="resolucion"
                  formControlName="resolucion"
                  class="form-select"
                  [class.input-error]="currentForm && isFieldInvalid(currentForm, 'resolucion')">
                  <option value="">Seleccionar resoluci√≥n</option>
                    <option *ngFor="let resolucion of resoluciones" [ngValue]="resolucion.value">
                      {{ resolucion.label }}
                    </option>
                </select>
                <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'resolucion')">
                  {{ getFieldError(currentForm, 'resolucion') }}
                </div>
                <small class="form-hint">La resoluci√≥n 4K solo est√° disponible para contenido VIP</small>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="fechaExpiracion" class="form-label">Fecha de Expiraci√≥n (opcional)</label>
              <input
                id="fechaExpiracion"
                type="date"
                formControlName="fechaExpiracion"
                class="form-input"
                [class.input-error]="currentForm && isFieldInvalid(currentForm, 'fechaExpiracion')">
              <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'fechaExpiracion')">
                {{ getFieldError(currentForm, 'fechaExpiracion') }}
              </div>
              <small class="form-hint">Deja vac√≠o si el contenido no expira</small>
            </div>
            <div class="form-group" *ngIf="actualGestor.tipoContenido === 'VIDEO'">
              <label for="duracion" class="form-label">Duraci√≥n (segundos) *</label>
              <input
                id="duracion"
                type="number"
                formControlName="duracion"
                class="form-input no-spinners"
                [class.input-error]="currentForm && isFieldInvalid(currentForm, 'duracion')"
                placeholder="Duraci√≥n en segundos">
              <div class="error-message" *ngIf="currentForm && isFieldInvalid(currentForm, 'duracion')">
                {{ getFieldError(currentForm, 'duracion') }}
              </div>
              <small class="form-hint">
                Ingresa la duraci√≥n aproximada del video en segundos
              </small>
            </div>

          <div class="form-row">
            <div class="form-group checkbox-group">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  formControlName="vip"
                  class="form-checkbox">
                Contenido VIP (solo para usuarios premium)
              </label>
            </div>
          </div>
          </div>
        </section>

        <!-- Botones de Acci√≥n -->
        <div class="form-actions">
          <button type="button" (click)="resetForm()" class="btn-secondary">
            Limpiar Formulario
          </button>
          <button type="submit" [disabled]="!currentForm.valid || (actualGestor.tipoContenido === 'AUDIO' ? (!selectedAudioFile || !selectedThumbnail) : (!selectedVideoUrl || !selectedThumbnail))" class="btn-primary">
             Subir Contenido de {{ actualGestor.tipoContenido | titlecase }}
          </button>
        </div>
      </form>
    </div>


  </main>
</div>
